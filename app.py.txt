import os
import requests
from flask import Flask, request, jsonify, render_template
from pydub import AudioSegment
from transformers import pipeline
from pyngrok import ngrok
from dotenv import load_dotenv
import io

load_dotenv()

app = Flask(__name__)

ASSEMBLYAI_API_KEY = os.getenv("ASSEMBLYAI_API_KEY")
NGROK_AUTH_TOKEN = os.getenv("NGROK_AUTH_TOKEN")

ngrok.set_auth_token(NGROK_AUTH_TOKEN)

sentiment_model = pipeline(
    "text-classification",
    model="bhadresh-savani/distilbert-base-uncased-emotion",
    return_all_scores=True
)

summarizer = pipeline("summarization")

def convert_audio(path):
    audio = AudioSegment.from_file(path)
    buffer = io.BytesIO()
    audio.export(buffer, format="flac")
    buffer.seek(0)
    return buffer

def transcribe_audio(path):
    headers = {"authorization": ASSEMBLYAI_API_KEY}

    upload = requests.post(
        "https://api.assemblyai.com/v2/upload",
        headers=headers,
        data=convert_audio(path).read()
    )

    audio_url = upload.json()["upload_url"]

    transcript = requests.post(
        "https://api.assemblyai.com/v2/transcript",
        headers=headers,
        json={"audio_url": audio_url}
    )

    tid = transcript.json()["id"]

    while True:
        status = requests.get(
            f"https://api.assemblyai.com/v2/transcript/{tid}",
            headers=headers
        ).json()

        if status["status"] == "completed":
            return status["text"]

def analyze_sentiment(text):
    result = sentiment_model(text)[0]
    scores = {r["label"]: r["score"] for r in result}

    positive = scores.get("joy", 0)
    negative = sum(scores.get(x, 0) for x in ["sadness", "anger", "fear", "disgust"])

    overall = "positive" if positive > negative else "negative" if negative > positive else "neutral"

    return scores, overall

def summarize(text):
    return summarizer(text, max_length=100, min_length=30, do_sample=False)[0]["summary_text"]

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/process_audio", methods=["POST"])
def process_audio():
    file = request.files["file"]
    path = os.path.join("uploads", file.filename)
    file.save(path)

    transcript = transcribe_audio(path)
    sentiments, overall = analyze_sentiment(transcript)
    summary = summarize(transcript)

    return jsonify({
        "transcript": transcript,
        "sentiments": sentiments,
        "overall_sentiment": overall,
        "summary": summary
    })

if __name__ == "__main__":
    os.makedirs("uploads", exist_ok=True)
    app.run()
